# Gene Families Evolution 

# CAFE  
**CAFE** is a software tool used to study the evolution of gene family sizes across a phylogenetic tree. While OrthoFinder tells us which genes belong to which family, CAFE tells us how those families have changed over time. 
[CAFE](https://github.com/hahnlab/CAFE) uses a stochastic Birth-Death model to simulate gene evolution, it estimates the global rate of gene family evolution, denoted as $\lambda$ and identifies specific branches in the tree 
where gene families have undergone unusually rapid expansion or contraction. 

## Preparing data 
Two inputs are required: an **ultrametric-tree**, yielded in output by IQtree, and a **table listing the number of genes per family for each species**, generated by Orthofinder. The tree is already avaible, instead the table 
needs changes. For this reason we process the original file `Orthogroups.GenCount.tsv`, the structure CAFE accepts is reported in `GenCount_CAFE.tsv`. 

```bash
NONE  Orthogroup  Aaeg  Aste  Cqui  Llon
NONE  OG0000000 93  0 5 9
NONE  OG0000001 81  0 5 0
NONE  OG0000002 33  21  25  1
NONE  OG0000003 10  5 8 0
NONE  OG0000004 0 0 5 90
NONE  OG0000005 0 0 58  1
NONE  OG0000006 26  0 16  9
NONE  OG0000007 1 0 4 91
NONE  OG0000008 0 0 0 48 
```
```bash
cd OrthoFinder/Results_Dec01/Orthogroups
sed $'s/^/NONE\t/g' Orthogroups.GeneCount.tsv | rev | cut -f 2- | rev > ../../../../07_GeneFamilies_Evolution/GeneCount_CAFE.tsv
```
-----
## Running CAFE

### Generating Error model 

Before running a true attempt it's recommended a Standard Analysis, wich calculates the average rate of gene turnover $\lambda$ across all species and all gene families in your dataset, giving a baseline expectation. 
The results will be used in the real CAFE run to improve the evolutionary inference. 
> CAFE process is not deterministic, for this reason a basal model could implement relevant statistics. 

```bash
conda activate tree
#[tree]
cafe5 -i GenCount_CAFE.tsv -t timetree.nwk -o Error_model -e
```

### One lambda $\lambda$

The first analysis is one One-lambda, it means the model assumes an average turnover rate of all gene families, implying that the tendency for gene families to expand or contract is kept constant across all species. 
Final output identifies gene families that deviate significantly from this average (p-value < 0.05).The error model is given in input too.
> As sad before, CAFE it is not deterministic. Due to prevent CAFE runs a local minimun instead of maximum in his maximum-likelihood analysis, we performed multiple rums at the same time (with a for structure) to compare different likelihood results from the same input parameters. 
```bash
#[tree]
for k in {1..5}; do for n in {1..10}; do mkdir -p 00_1L/${k}K/${n}N; cafe5 -i GeneCount_CAFE.tsv -t timetree.nwk -o 00_1L/${k}K/${n}N -eError_model/Base_error_model.txt -k ${k}; done; done 
```

### Two lambdas $\lambda$

Different lineages often face different evolutionary pressures that cause them to gain or lose genes faster than others. We suspect that a specific group of species is evolving differently from the rest of the tree. 
With this purpose we introduce two lambda values: The standard rate for most of the tree and the specific rate for our clade of interest. To implement this strategy it's required to modify the `timetree.nwk` file specifing 
for each tip its lambda value. 

timetree.nwk file:
```bash
#add timetree2L.nwk structure
```

Then run CAFE again: 
```bash
#[tree]
for k in {1..5}; do for n in {1..10}; do mkdir -p 00_2L/${k}K/${n}N; cafe5 -i GeneCount_CAFE.tsv -t timetree.nwk -o 00_2L/${k}K/${n}N -y timetree2L.nwk -eError_model/Base_error_model.txt -k ${k}; done; done  
```
-----

## Key Parameters

+ **Lambda**: represents the maximum-likelihood estimation of the gene turnover rate. Since the input is a time-calibrated tree, $\lambda$ is expressed as the number of gains/losses per gene per million years. This can be a single Global rate assuming all species evolve at the same speed, or split into Local rates grouping species into different regimes based on biological hypotheses.

+ **Gamma**: models the difference between families. Unlike lambda, which models the difference between species, this value expresses the probability of families, within a distribution, depending on their variability. Typical usage involves setting $\Gamma$ between 2 and 5 categories.

+ **Alpha**: this parameter defines the shape of the Gamma distribution curve around the mean $\lambda$. Small $\alpha$ means high rate variation, most gene families evolve slowly, but a few evolve very rapidly. Large $\alpha$ means low rate variation, most gene families evolve at rates very close to the mean $\lambda$.

+ **Epsilon**: this represents the proportion of static gene familiesâ€”those that show zero turnover across the entire tree. Including this parameter helps prevent the model from overestimating rates by forcing static families into slow-evolving categories.

