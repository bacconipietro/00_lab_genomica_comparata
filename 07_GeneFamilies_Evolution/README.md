# Gene Families Evolution 

# CAFE  
**CAFE** is a software tool used to study the evolution of gene family sizes across a phylogenetic tree. While OrthoFinder tells us which genes belong to which family, CAFE tells us how those families have changed over time. 
[CAFE](https://github.com/hahnlab/CAFE) uses a stochastic Birth-Death model to simulate gene evolution, it estimates the global rate of gene family evolution, denoted as $\lambda$ and identifies specific branches in the tree 
where gene families have undergone unusually rapid expansion or contraction. 

## Preparing data 
Two inputs are required: an **ultrametric-tree**, yielded in output by IQtree, and a **table listing the number of genes per family for each species**, generated by Orthofinder. The tree is already avaible, instead the table 
needs changes. For this reason we process the original file `Orthogroups.GenCount.tsv`, the structure CAFE accepts is reported in `GenCount_CAFE.tsv`. 

```bash
NONE  Orthogroup  Aaeg  Aste  Cqui  Llon
NONE  OG0000000 93  0 5 9
NONE  OG0000001 81  0 5 0
NONE  OG0000002 33  21  25  1
NONE  OG0000003 10  5 8 0
NONE  OG0000004 0 0 5 90
NONE  OG0000005 0 0 58  1
NONE  OG0000006 26  0 16  9
NONE  OG0000007 1 0 4 91
NONE  OG0000008 0 0 0 48 
```
```bash
cd OrthoFinder/Results_Dec01/Orthogroups
sed $'s/^/NONE\t/g' Orthogroups.GeneCount.tsv | rev | cut -f 2- | rev > ../../../../07_GeneFamilies_Evolution/GeneCount_CAFE.tsv
```
-----
## Running CAFE

### Generating Error model 

Before running a true attempt it's recommended a Standard Analysis, wich calculates the average rate of gene turnover $\lambda$ across all species and all gene families in your dataset, giving a baseline expectation. 
The results will be used in the real CAFE run to improve the evolutionary inference. 
> CAFE process is not deterministic, for this reason a basal model could implement relevant statistics. 

```bash
conda activate tree
#[tree]
cafe5 -i GenCount_CAFE.tsv -t timetree.nwk -o Error_model -e
```

### One lambda $\lambda$

The first analysis is one One-lambda, it means the model assumes an average turnover rate of all gene families, implying that the tendency for gene families to expand or contract is kept constant across all species. 
Final output identifies gene families that deviate significantly from this average (p-value < 0.05).The error model is given in input too.
> As sad before, CAFE it is not deterministic. Due to prevent CAFE runs a local minimun instead of maximum in his maximum-likelihood analysis, we performed multiple rums at the same time (with a for structure) to compare different likelihood results from the same input parameters. 
```bash
#[tree]
for k in {1..5}; do for n in {1..10}; do mkdir -p 00_1L/${k}K/${n}N; cafe5 -i GeneCount_CAFE.tsv -t timetree.nwk -o 00_1L/${k}K/${n}N -eError_model/Base_error_model.txt -k ${k}; done; done 
```

### Two lambdas $\lambda$

Different lineages often face different evolutionary pressures that cause them to gain or lose genes faster than others. We suspect that a specific group of species is evolving differently from the rest of the tree. 
With this purpose we introduce two lambda values: The standard rate for most of the tree and the specific rate for our clade of interest. To implement this strategy it's required to modify the `timetree.nwk` file specifing 
for each tip its lambda value. 

timetree.nwk file:
```bash
#add timetree2L.nwk structure
```

Then run CAFE again: 
```bash
#[tree]
for k in {1..5}; do for n in {1..10}; do mkdir -p 00_2L/${k}K/${n}N; cafe5 -i GeneCount_CAFE.tsv -t timetree.nwk -o 00_2L/${k}K/${n}N -y timetree2L.nwk -eError_model/Base_error_model.txt -k ${k}; done; done  
```
-----

## Key Parameters

+ **Lambda**: represents the maximum-likelihood estimation of the gene turnover rate. Since the input is a time-calibrated tree, $\lambda$ is expressed as the number of gains/losses per gene per million years. This can be a single Global rate assuming all species evolve at the same speed, or split into Local rates grouping species into different regimes based on biological hypotheses.

+ **Gamma**: models the difference between families. Unlike lambda, which models the difference between species, this value expresses the probability of families, within a distribution, depending on their variability. Typical usage involves setting $\Gamma$ between 2 and 5 categories.

+ **Alpha**: this parameter defines the shape of the Gamma distribution curve around the mean $\lambda$. Small $\alpha$ means high rate variation, most gene families evolve slowly, but a few evolve very rapidly. Large $\alpha$ means low rate variation, most gene families evolve at rates very close to the mean $\lambda$.

+ **Epsilon**: this represents the proportion of static gene familiesâ€”those that show zero turnover across the entire tree. Including this parameter helps prevent the model from overestimating rates by forcing static families into slow-evolving categories.


## AIC-BIC model selection
To decide which run is the best, we use Information Criteria: AIC and BIC. 

#### _AIC_ 
Akaike Information Criterion is designed to estimate the relative quality of statistical models for a given set of data. It deals with the trade-off between the goodness of fit and the simplicity of the model. The model with the lowest AIC is considered the best. 

+ $$AIC = 2k - 2\ln(L)$$

#### _BIC_
Bayesian Information Criterion is similar to AIC but is often more "conservative." It introduces a heavier penalty for models with more parameters, especially as your sample number of gene families increases. 

+ $$BIC = k\ln(n) - 2\ln(L)$$


The following pipeline execute: 
+ Grepping the likelihood values from the 10 technical replicates. For-loop for one $\Gamma$. 
```bash
for folder in */; do lnL=$(grep "lnL" ${folder}/Base_results.txt | grep -oE "[0-9]*([\.,][0-9]*)?"); L=$(grep "Lambda" ${folder}/Base_results.txt | grep -oE "[0-9]*\.[0-9]*"); E=$(grep "Epsilon" ${folder}/Base_results.txt | grep -oE "[0-9]*\.[0-9]*"); echo -e "$lnL\t$L\t$E" >> sum_results.tsv; done
```

+ Grepping the likelihood values from the 10 technical replicates. For-loop for 2 < $\Gamma$ < 5.
```bash
for i in */; do cd $i; for folder in */; do lnL=$(grep "lnL" ${folder}/Gamma_results.txt | grep -oE "[0-9]*([\.,][0-9]*)?"); L=$(grep "Lambda" ${folder}/Gamma_results.txt | grep -oE "[0-9]*\.[0-9]*"); E=$(grep "Epsilon" ${folder}/Gamma_results.txt | grep -oE "[0-9]*\.[0-9]*"); A=$(grep "Alpha" ${folder}/Gamma_results.txt | grep -oE "[0-9]*\.[0-9]*"); echo -e "$lnL\t$L\t$E\t$A" >> sum_results.tsv; done; cd ..; done
```

+ A for-loop that extracts the best likelihood from each `sum_results.tsv` and overwrites it into `all_L.txt`. 
```bash
for f in */; do cut -f1 "$f"/sum_results.tsv | sort -n | head -n1; done > all_L.txt
```

The first likelihood value belongs to one $\Gamma$ value run, the second to the run with two values, and so on. To perform the test, it is necessary to manually define the number of 'free parameters' for each run, which are determined by summing possible values assumed by $\lambda$ and $\Gamma$. It is also necessary to define natural logarithm ($\ln$) of trees' number reported in `Base_asr.tre` or `Gamma_asr.tre`.

```bash
nano all_L.txt

84709.6  2
81079.7  3
80500.5  4
80441.4  5
80439.8  6
```
```bash
grep "OG" Base_asr.tre | wc -l 
10022
```
```
ln(10022) = 9.21
```

Finally, we perform the calculation of the two indicators, which will be carried out separately for both the `00_1L` and `00_2L` runs, to then compare them and choose the best-fitting model. 
```bash
paste --delimiters=$"\t" all_L.txt <(while IFS=$'\t' read -r L k; do echo "2*$k + 2*$L" | bc; done < all_L.txt) <(while IFS=$'\t' read -r L k; do echo "$k*9.21 + 2*$L" | bc; done < all_L.txt) | sort -k4,4n > AIC_BIC.tsv
```

The final values for the two respective CAFE runs are reported in `AIC_BIC.tsv`. The run with the lowest AIC value describes our model better than all others. The best model features 5 free parameters, meaning the correct folder is `00_1L/4K`. The best likelihood value points to technical replicate `/9N`. 
```
80441.4 5       160892.8        160928.85	(1L)
80435.4 7       160884.8        160935.27	(2L)
```
